===========================
å†…æ ¸æ¨¡å¼è®¾ç½® (KMS) ä¸­æ–‡æ–‡æ¡£
===========================

.. contents:: ç›®å½•
   :depth: 3
   :local:

================
å†™åœ¨å‰é¢ï¼šç»™åˆå­¦è€…
================

å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦Linuxæ˜¾ç¤ºé©±åŠ¨ï¼Œç›´æ¥çœ‹åé¢çš„æŠ€æœ¯æ–‡æ¡£ä¼šå¾ˆæ‡µã€‚
è¿™ä¸€èŠ‚ç”¨é€šä¿—çš„è¯­è¨€å¸®ä½ å»ºç«‹åŸºæœ¬æ¦‚å¿µã€‚

ä»€ä¹ˆæ˜¯ DRM/KMSï¼Ÿ
----------------

**DRM** (Direct Rendering Manager) æ˜¯ Linux å†…æ ¸ä¸­ç®¡ç†æ˜¾å¡/æ˜¾ç¤ºçš„å­ç³»ç»Ÿã€‚

**KMS** (Kernel Mode Setting) æ˜¯ DRM çš„ä¸€éƒ¨åˆ†ï¼Œä¸“é—¨è´Ÿè´£"è®¾ç½®æ˜¾ç¤ºæ¨¡å¼"ï¼Œ
æ¯”å¦‚åˆ†è¾¨ç‡ã€åˆ·æ–°ç‡ã€é¢œè‰²æ ¼å¼ç­‰ã€‚

**é€šä¿—ç†è§£**ï¼š

æƒ³è±¡ä½ è¦çœ‹ç”µè§†ï¼š

- **ç”µè§†å°**ï¼ˆåº”ç”¨ç¨‹åºï¼‰åˆ¶ä½œèŠ‚ç›®å†…å®¹ï¼ˆå›¾åƒæ•°æ®ï¼‰
- **å‘å°„å¡”**ï¼ˆCRTCï¼‰æŠŠèŠ‚ç›®ä¿¡å·å‘å°„å‡ºå»
- **è°ƒåˆ¶å™¨**ï¼ˆEncoderï¼‰æŠŠä¿¡å·è½¬æ¢æˆç‰¹å®šæ ¼å¼ï¼ˆæ¨¡æ‹Ÿ/æ•°å­—/HDMI/MIPIç­‰ï¼‰
- **å¤©çº¿æ¥å£**ï¼ˆConnectorï¼‰æ˜¯ç‰©ç†è¿æ¥ç‚¹
- **ç”µè§†æœº**ï¼ˆPanelï¼‰æœ€ç»ˆæ˜¾ç¤ºç”»é¢

DRM/KMS å°±æ˜¯ç®¡ç†è¿™æ•´ä¸ªä¼ è¾“é“¾è·¯çš„å†…æ ¸æ¡†æ¶ã€‚

ä¸ºä»€ä¹ˆéœ€è¦ DRM/KMSï¼Ÿ
--------------------

åœ¨æ²¡æœ‰ DRM ä¹‹å‰ï¼Œæ˜¾ç¤ºé©±åŠ¨å„å†™å„çš„ï¼Œåº”ç”¨ç¨‹åºå¾ˆéš¾å…¼å®¹ä¸åŒç¡¬ä»¶ã€‚

DRM/KMS æä¾›äº†ï¼š

1. **ç»Ÿä¸€çš„æ¥å£** - åº”ç”¨ç¨‹åºä¸ç”¨å…³å¿ƒåº•å±‚æ˜¯ä»€ä¹ˆæ˜¾å¡
2. **å†…æ ¸æ€æ¨¡å¼è®¾ç½®** - åˆ†è¾¨ç‡åˆ‡æ¢æ›´ç¨³å®šï¼Œä¸ä¼šèŠ±å±
3. **å¤šæ˜¾ç¤ºå™¨æ”¯æŒ** - æ ‡å‡†åŒ–çš„å¤šå±ç®¡ç†
4. **å®‰å…¨æ€§** - åº”ç”¨ç¨‹åºä¸èƒ½ç›´æ¥æ“ä½œæ˜¾å¡ç¡¬ä»¶

========================
æ ¸å¿ƒæ¦‚å¿µé€šä¿—è§£é‡Šï¼ˆé‡è¦ï¼ï¼‰
========================

ä¸‹é¢ç”¨ä¸€ä¸ª**ç”µè§†å°æ’­å‡ºç³»ç»Ÿ**çš„æ¯”å–»æ¥è§£é‡Šå„ä¸ªç»„ä»¶ï¼š

.. code-block:: text

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        æ˜¾ç¤ºç³»ç»Ÿæ¯”å–»å›¾                               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                                     â”‚
    â”‚   ğŸ“º ç”µè§†å°æ’­å‡ºç³»ç»Ÿ                    ğŸ’» Linuxæ˜¾ç¤ºç³»ç»Ÿ              â”‚
    â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
    â”‚                                                                     â”‚
    â”‚   èŠ‚ç›®å½•åƒå¸¦/ç¡¬ç›˜        â†â†’          Framebuffer (å¸§ç¼“å†²åŒº)         â”‚
    â”‚   (å­˜å‚¨èŠ‚ç›®å†…å®¹)                      (å­˜å‚¨å›¾åƒæ•°æ®)                 â”‚
    â”‚        â†“                                   â†“                       â”‚
    â”‚   æ’­æ”¾æœåŠ¡å™¨            â†â†’           Plane (å¹³é¢/å›¾å±‚)              â”‚
    â”‚   (è¯»å–å¹¶è¾“å‡ºå†…å®¹)                    (è¯»å–framebufferå¹¶å åŠ )        â”‚
    â”‚        â†“                                   â†“                       â”‚
    â”‚   ä¸»æ§å®¤/å¯¼æ’­å°         â†â†’           CRTC (æ˜¾ç¤ºæ§åˆ¶å™¨)              â”‚
    â”‚   (æ··åˆå¤šè·¯ä¿¡å·ã€åŠ å°æ ‡)              (æ··åˆå¤šå›¾å±‚ã€ç”Ÿæˆæ—¶åº)          â”‚
    â”‚        â†“                                   â†“                       â”‚
    â”‚   ä¿¡å·è°ƒåˆ¶å™¨            â†â†’           Encoder (ç¼–ç å™¨)               â”‚
    â”‚   (è½¬æˆç‰¹å®šä¼ è¾“æ ¼å¼)                  (è½¬æˆHDMI/MIPI/LVDSæ ¼å¼)       â”‚
    â”‚        â†“                                   â†“                       â”‚
    â”‚   å‘å°„å¤©çº¿/çº¿ç¼†æ¥å£     â†â†’           Connector (è¿æ¥å™¨)             â”‚
    â”‚   (ç‰©ç†è¾“å‡ºæ¥å£)                      (ç‰©ç†æ¥å£ï¼Œè·å–æ˜¾ç¤ºå™¨ä¿¡æ¯)      â”‚
    â”‚        â†“                                   â†“                       â”‚
    â”‚   ç”µè§†æœº                â†â†’           Panel (é¢æ¿)                   â”‚
    â”‚   (æœ€ç»ˆæ˜¾ç¤ºè®¾å¤‡)                      (LCD/OLEDå±å¹•)                 â”‚
    â”‚                                                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å„ç»„ä»¶è¯¦ç»†è§£é‡Š
--------------

**1. Framebufferï¼ˆå¸§ç¼“å†²åŒºï¼‰**

::

    ä½œç”¨ï¼šå­˜å‚¨è¦æ˜¾ç¤ºçš„å›¾åƒæ•°æ®ï¼Œå°±æ˜¯ä¸€å—å†…å­˜
    
    ä¸¾ä¾‹ï¼šä¸€å¼  1920Ã—1080 çš„å›¾ç‰‡ï¼Œæ¯ä¸ªåƒç´ 4å­—èŠ‚(RGBA)
          éœ€è¦ 1920 Ã— 1080 Ã— 4 = 8,294,400 å­—èŠ‚ â‰ˆ 8MB å†…å­˜

**2. Planeï¼ˆå¹³é¢/å›¾å±‚ï¼‰**

::

    ä½œç”¨ï¼šä»framebufferè¯»å–æ•°æ®ï¼Œå¯ä»¥æœ‰å¤šä¸ªå›¾å±‚å åŠ 
    
    ä¸¾ä¾‹ï¼šæ‰‹æœºå±å¹•ä¸Šï¼Œåº•å±‚æ˜¯æ¡Œé¢å£çº¸ï¼Œä¸Šé¢å åŠ APPçª—å£ï¼Œ
          æœ€ä¸Šé¢å åŠ çŠ¶æ€æ ã€‚æ¯ä¸€å±‚å°±æ˜¯ä¸€ä¸ªPlaneã€‚
    
    ç±»å‹ï¼š
    - Primary Planeï¼šä¸»å›¾å±‚ï¼Œå¿…é¡»æœ‰
    - Overlay Planeï¼šå åŠ å›¾å±‚ï¼Œç”¨äºè§†é¢‘ã€æ¸¸æˆåŠ é€Ÿ
    - Cursor Planeï¼šé¼ æ ‡å…‰æ ‡å›¾å±‚

**3. CRTCï¼ˆæ˜¾ç¤ºæ§åˆ¶å™¨ï¼‰**

::

    ä½œç”¨ï¼šæ˜¾ç¤ºæ—¶åºç”Ÿæˆå™¨ + å›¾å±‚æ··åˆå™¨
    
    åå­—ç”±æ¥ï¼šå¤è€çš„CRTæ˜¾ç¤ºå™¨éœ€è¦ç²¾ç¡®çš„æ‰«ææ—¶åºï¼Œæ‰€ä»¥å«CRTC
            (Cathode Ray Tube Controllerï¼Œé˜´æå°„çº¿ç®¡æ§åˆ¶å™¨)
    
    å®ƒåšä»€ä¹ˆï¼š
    1. ç”Ÿæˆè¡ŒåŒæ­¥(HSYNC)ã€åœºåŒæ­¥(VSYNC)ä¿¡å·
    2. æ§åˆ¶æœ‰æ•ˆæ˜¾ç¤ºåŒºåŸŸ (Active Area)
    3. æ§åˆ¶æ¶ˆéšåŒºåŸŸ (Blanking: HBP, HFP, VBP, VFP)
    4. æ··åˆå¤šä¸ªPlaneçš„å†…å®¹
    
    RK3568æœ‰å‡ ä¸ªï¼š3ä¸ªï¼ˆVOP2æœ‰3ä¸ªè§†é¢‘è¾“å‡ºç«¯å£ï¼‰

**4. Encoderï¼ˆç¼–ç å™¨ï¼‰**

::

    ä½œç”¨ï¼šæŠŠCRTCè¾“å‡ºçš„é€šç”¨è§†é¢‘ä¿¡å·è½¬æ¢æˆç‰¹å®šæ¥å£åè®®
    
    ç±»å‹ä¸¾ä¾‹ï¼š
    - MIPI DSI Encoderï¼šè½¬æˆMIPI DSIä¿¡å·ï¼ˆæ‰‹æœºå±å¸¸ç”¨ï¼‰
    - HDMI Encoderï¼šè½¬æˆHDMIä¿¡å·
    - LVDS Encoderï¼šè½¬æˆLVDSä¿¡å·ï¼ˆå·¥æ§å±å¸¸ç”¨ï¼‰
    - DP Encoderï¼šè½¬æˆDisplayPortä¿¡å·
    
    RK3568çš„dw-mipi-dsi.cå°±æ˜¯å®ç°MIPI DSI Encoder

**5. Connectorï¼ˆè¿æ¥å™¨ï¼‰**

::

    ä½œç”¨ï¼šè¡¨ç¤ºç‰©ç†è¾“å‡ºæ¥å£ï¼Œè´Ÿè´£æ£€æµ‹æ˜¾ç¤ºå™¨å’Œè·å–å…¶å‚æ•°
    
    åŠŸèƒ½ï¼š
    1. çƒ­æ’æ‹”æ£€æµ‹ï¼ˆHDMIæ’æ‹”ï¼‰
    2. è¯»å–EDIDï¼ˆæ˜¾ç¤ºå™¨è‡ªè¿°ä¿¡æ¯ï¼šæ”¯æŒçš„åˆ†è¾¨ç‡ã€å‚å•†ç­‰ï¼‰
    3. å‘ä¸ŠæŠ¥å‘Šæ˜¾ç¤ºå™¨çŠ¶æ€ï¼ˆå·²è¿æ¥/æ–­å¼€ï¼‰
    
    ä¸Panelçš„å…³ç³»ï¼š
    - HDMIè¿™ç§å¯çƒ­æ’æ‹”çš„ï¼ŒConnectorè‡ªå·±å°±å¤Ÿäº†
    - MIPIå±è¿™ç§å›ºå®šè¿æ¥çš„ï¼ŒConnectorä¼šå…³è”ä¸€ä¸ªPanelå¯¹è±¡

**6. Panelï¼ˆé¢æ¿ï¼‰**

::

    ä½œç”¨ï¼šæè¿°å…·ä½“LCDå±å¹•çš„å‚æ•°å’Œæ§åˆ¶æ–¹æ³•
    
    åŒ…å«ä»€ä¹ˆï¼š
    1. æ—¶åºå‚æ•°ï¼ˆåˆ†è¾¨ç‡ã€HBP/HFP/VBP/VFPç­‰ï¼‰
    2. åˆå§‹åŒ–å‘½ä»¤åºåˆ—ï¼ˆå¾ˆå¤šMIPIå±éœ€è¦å‘é€åˆå§‹åŒ–å‘½ä»¤ï¼‰
    3. ç”µæºæ§åˆ¶ï¼ˆä¸Šç”µæ—¶åºã€å¤ä½æ—¶åºï¼‰
    4. èƒŒå…‰æ§åˆ¶
    
    panel-simple.c å°±æ˜¯ä¸€ä¸ªé€šç”¨é¢æ¿é©±åŠ¨ï¼Œæ”¯æŒå¾ˆå¤šå±å¹•

====================
æ•°æ®æµï¼šä»åº”ç”¨åˆ°å±å¹•
====================

ä¸€å¸§å›¾åƒå¦‚ä½•æ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼š

.. code-block:: text

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                  â”‚
    â”‚  [åº”ç”¨ç¨‹åº] â”€â”€å†™å…¥â”€â”€â–¶ [Framebufferå†…å­˜]                          â”‚
    â”‚                              â”‚                                   â”‚
    â”‚                              â–¼                                   â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
    â”‚                    â”‚  Plane (å›¾å±‚)   â”‚ â—€â”€â”€ è®¾ç½®ä½ç½®ã€ç¼©æ”¾ç­‰      â”‚
    â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
    â”‚                             â”‚                                    â”‚
    â”‚                             â–¼                                    â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚   â”‚                    CRTC                                  â”‚   â”‚
    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
    â”‚   â”‚  â”‚  Planeæ··åˆï¼š                                       â”‚  â”‚   â”‚
    â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚  â”‚   â”‚
    â”‚   â”‚  â”‚  â”‚ Cursor  â”‚ â† æœ€ä¸Šå±‚                             â”‚  â”‚   â”‚
    â”‚   â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                      â”‚  â”‚   â”‚
    â”‚   â”‚  â”‚  â”‚ Overlay â”‚ â† è§†é¢‘å±‚                             â”‚  â”‚   â”‚
    â”‚   â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                      â”‚  â”‚   â”‚
    â”‚   â”‚  â”‚  â”‚ Primary â”‚ â† ä¸»ç•Œé¢                             â”‚  â”‚   â”‚
    â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚  â”‚   â”‚
    â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
    â”‚   â”‚                         â”‚                                â”‚   â”‚
    â”‚   â”‚            ç”Ÿæˆæ˜¾ç¤ºæ—¶åº â–¼ (HSYNC, VSYNC, DE)            â”‚   â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                             â”‚                                    â”‚
    â”‚                             â–¼                                    â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
    â”‚                    â”‚    Encoder      â”‚                          â”‚
    â”‚                    â”‚  (dw-mipi-dsi)  â”‚                          â”‚
    â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
    â”‚                             â”‚ MIPI DSI åè®®                      â”‚
    â”‚                             â–¼                                    â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
    â”‚                    â”‚   D-PHY ç‰©ç†å±‚   â”‚                          â”‚
    â”‚                    â”‚(inno-video-phy) â”‚                          â”‚
    â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
    â”‚                             â”‚ å·®åˆ†ä¿¡å·çº¿                         â”‚
    â”‚                             â–¼                                    â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
    â”‚                    â”‚   LCD Panel     â”‚                          â”‚
    â”‚                    â”‚  (panel-simple) â”‚                          â”‚
    â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
    â”‚                                                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

=============================
RK3568 æ˜¾ç¤ºé©±åŠ¨æ–‡ä»¶å¯¹ç…§è¡¨
=============================

   * DRMç»„ä»¶
     - RK3568é©±åŠ¨æ–‡ä»¶
     - è¯´æ˜
   * CRTC
     - rockchip_drm_vop2.c
     - VOP2æ˜¾ç¤ºæ§åˆ¶å™¨
   * Encoder
     - dw-mipi-dsi.c
     - MIPI DSIæ§åˆ¶å™¨
   * Connector
     - dw-mipi-dsi.c
     - åŒä¸Šï¼ˆå†…å«connectorå®ç°ï¼‰
   * Panel
     - panel-simple.c
     - é€šç”¨é¢æ¿é©±åŠ¨
   * PHY
     - phy-rockchip-inno-video-combo-phy.c
     - MIPI D-PHYç‰©ç†å±‚

===================
æ˜¾ç¤ºæ—¶åºå‚æ•°è¯¦è§£
===================

çœ‹å±å¹•æ•°æ®æ‰‹å†Œæ—¶ç»å¸¸çœ‹åˆ°è¿™äº›å‚æ•°ï¼Œææ‡‚å®ƒä»¬å¾ˆé‡è¦ï¼š

    ä¸€è¡Œä¿¡å·çš„æ—¶åºï¼š
    
    â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸€è¡Œæ€»æ—¶é—´(htotal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
    
    â”œâ”€HBPâ”€â”¼â”€â”€â”€â”€â”€â”€ æœ‰æ•ˆæ˜¾ç¤ºåŒº(hactive) â”€â”€â”€â”€â”€â”€â”¼â”€HFPâ”€â”¼â”€HSYNCâ”€â”¤
    
    HBP = Horizontal Back Porch    (è¡ŒåŒæ­¥åè‚©ï¼ŒåŒæ­¥ä¿¡å·ç»“æŸåˆ°æœ‰æ•ˆæ•°æ®å¼€å§‹)
    HFP = Horizontal Front Porch   (è¡ŒåŒæ­¥å‰è‚©ï¼Œæœ‰æ•ˆæ•°æ®ç»“æŸåˆ°åŒæ­¥ä¿¡å·å¼€å§‹)
    HSYNC = Horizontal Sync        (è¡ŒåŒæ­¥è„‰å†²å®½åº¦)
    hactive = æœ‰æ•ˆåƒç´ æ•°           (æ¯”å¦‚1920)


â€‹    
â€‹    ä¸€å¸§ä¿¡å·çš„æ—¶åºï¼ˆå‚ç›´æ–¹å‘ç±»ä¼¼ï¼‰ï¼š
â€‹    
    â”œâ”€VBPâ”€â”¼â”€â”€â”€â”€â”€â”€ æœ‰æ•ˆæ˜¾ç¤ºåŒº(vactive) â”€â”€â”€â”€â”€â”€â”¼â”€VFPâ”€â”¼â”€VSYNCâ”€â”¤
    
    VBP = Vertical Back Porch
    VFP = Vertical Front Porch
    VSYNC = Vertical Sync
    vactive = æœ‰æ•ˆè¡Œæ•°            (æ¯”å¦‚1080)

**è®¡ç®—åƒç´ æ—¶é’Ÿï¼š**

::

    pixel_clock = htotal Ã— vtotal Ã— refresh_rate
    
    ä¾‹å¦‚ 1920Ã—1080@60Hzï¼š
    htotal = 1920 + 88 + 148 + 44 = 2200
    vtotal = 1080 + 4 + 36 + 5 = 1125
    pixel_clock = 2200 Ã— 1125 Ã— 60 = 148,500,000 Hz â‰ˆ 148.5 MHz

==================

å¼€æœºæ˜¾ç¤ºæµç¨‹
==================

ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œæ˜¾ç¤ºåˆå§‹åŒ–çš„å¤§è‡´æµç¨‹ï¼š

    1. å†…æ ¸åŠ è½½æ˜¾ç¤ºç›¸å…³é©±åŠ¨ï¼ˆé€šè¿‡è®¾å¤‡æ ‘åŒ¹é…ï¼‰
       â”‚
       â”œâ”€â”€ VOP2é©±åŠ¨åˆå§‹åŒ– (CRTC)
       â”œâ”€â”€ DSIé©±åŠ¨åˆå§‹åŒ– (Encoder + Connector)
       â”œâ”€â”€ PHYé©±åŠ¨åˆå§‹åŒ–
       â””â”€â”€ Panelé©±åŠ¨åˆå§‹åŒ–
       â”‚
    2. DRMæ ¸å¿ƒç»‘å®šå„ç»„ä»¶
       â”‚
       â”œâ”€â”€ drm_encoder_init()    æ³¨å†Œencoder
       â”œâ”€â”€ drm_connector_init()  æ³¨å†Œconnector
       â””â”€â”€ drm_panel_attach()    ç»‘å®španel
       â”‚
    3. ç”¨æˆ·ç©ºé—´è¯·æ±‚æ˜¾ç¤º
       â”‚
       â”œâ”€â”€ drm_panel_prepare()   Panelä¸Šç”µã€å‘é€åˆå§‹åŒ–å‘½ä»¤
       â”œâ”€â”€ phy_power_on()        PHYä¸Šç”µã€é…ç½®PLL
       â”œâ”€â”€ encoder_enable()      é…ç½®DSIæ§åˆ¶å™¨ã€å¼€å§‹ä¼ è¾“
       â””â”€â”€ drm_panel_enable()    å¼€èƒŒå…‰
       â”‚
    4. æŒç»­åˆ·æ–°æ˜¾ç¤º
       â”‚
       â””â”€â”€ CRTCæŒ‰æ—¶åºä¸æ–­æ‰«æframebufferï¼Œé€šè¿‡DSIå‘é€åˆ°å±å¹•

===================
å­¦ä¹ å»ºè®®
===================

å¦‚æœä½ æƒ³æ·±å…¥ç†è§£è¿™äº›ä»£ç ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºï¼š

**ç¬¬ä¸€æ­¥ï¼šç†è§£Panelé©±åŠ¨ï¼ˆæœ€ç®€å•ï¼‰**

é˜…è¯» ``panel-simple.c``ï¼Œå…³æ³¨ï¼š

- ``struct panel_desc`` ç»“æ„ä½“ï¼ˆå±å¹•å‚æ•°ï¼‰
- ``panel_simple_prepare()`` å‡½æ•°ï¼ˆä¸Šç”µæµç¨‹ï¼‰
- ``panel_simple_enable()`` å‡½æ•°ï¼ˆä½¿èƒ½æµç¨‹ï¼‰

**ç¬¬äºŒæ­¥ï¼šç†è§£DSIæ§åˆ¶å™¨é©±åŠ¨**

é˜…è¯» ``dw-mipi-dsi.c``ï¼Œå…³æ³¨ï¼š

- ``struct dw_mipi_dsi`` ä¸»ç»“æ„ä½“
- ``dw_mipi_dsi_encoder_enable()`` å¼€å¯æµç¨‹
- ``dw_mipi_dsi_transfer()`` å‘½ä»¤å‘é€

**ç¬¬ä¸‰æ­¥ï¼šç†è§£PHYé©±åŠ¨**

é˜…è¯» ``phy-rockchip-inno-video-combo-phy.c``ï¼Œå…³æ³¨ï¼š

- PLLé…ç½®ï¼šå¦‚ä½•æ ¹æ®ç›®æ ‡é€Ÿç‡è®¡ç®—åˆ†é¢‘ç³»æ•°
- æ—¶åºé…ç½®ï¼šMIPI D-PHYçš„å„ç§æ—¶åºå‚æ•°

**ç¬¬å››æ­¥ï¼šåŠ¨æ‰‹å®è·µ**

- å°è¯•ç§»æ¤ä¸€ä¸ªæ–°çš„MIPIå±å¹•
- æ ¹æ®å±å¹•æ•°æ®æ‰‹å†Œå¡«å†™æ—¶åºå‚æ•°
- æ·»åŠ åˆå§‹åŒ–å‘½ä»¤åºåˆ—

=====================================
å¸¸è§é—®é¢˜è§£ç­”
=====================================

**Q: ä»€ä¹ˆæ—¶å€™ç”¨MIPI DSIï¼Œä»€ä¹ˆæ—¶å€™ç”¨LVDSã€RGBï¼Ÿ**

::

    MIPI DSI: æ‰‹æœº/å¹³æ¿å±å¹•ï¼Œé«˜åˆ†è¾¨ç‡ï¼Œå¼•è„šå°‘ï¼ˆ4å¯¹å·®åˆ†çº¿å¯è¾¾1080pï¼‰
    LVDS:     å·¥æ§å±ã€è½¦è½½å±ï¼Œä¸­ç­‰åˆ†è¾¨ç‡ï¼ŒæŠ—å¹²æ‰°å¼º
    RGB:      ä½åˆ†è¾¨ç‡å°å±ï¼Œå¼•è„šå¤šï¼ˆ24æ ¹æ•°æ®çº¿ï¼‰ï¼Œç®€å•ç›´æ¥

**Q: Video Mode å’Œ Command Mode æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

::

    Video Mode: 
    - ä¸»æ§æŒç»­å‘é€åƒç´ æ•°æ®ï¼Œå±å¹•æ— éœ€å¸§ç¼“å­˜
    - ç±»ä¼¼ä¼ ç»Ÿæ˜¾ç¤ºå™¨ï¼Œé€‚åˆè§†é¢‘æ’­æ”¾
    - å¤§å¤šæ•°å±å¹•ä½¿ç”¨è¿™ç§æ¨¡å¼
    
    Command Mode:
    - ä¸»æ§æŒ‰éœ€å‘é€æ•°æ®ï¼Œå±å¹•å†…ç½®å¸§ç¼“å­˜(GRAM)
    - çœç”µï¼ˆé™æ€ç”»é¢ä¸ç”¨æŒç»­åˆ·æ–°ï¼‰
    - å¸¸è§äºä½åŠŸè€—ç©¿æˆ´è®¾å¤‡

**Q: ä¸ºä»€ä¹ˆæˆ‘çš„å±å¹•ä¸äº®ï¼Ÿ**

æ£€æŸ¥é¡ºåºï¼š

::

    1. ç”µæºæ˜¯å¦æ­£å¸¸ï¼Ÿï¼ˆæµ‹é‡VCCç”µå‹ï¼‰
    2. å¤ä½æ—¶åºæ˜¯å¦æ­£ç¡®ï¼Ÿï¼ˆreset-gpioï¼‰
    3. åˆå§‹åŒ–å‘½ä»¤æ˜¯å¦å‘é€ï¼Ÿï¼ˆæ·»åŠ è°ƒè¯•æ‰“å°ï¼‰
    4. æ—¶åºå‚æ•°æ˜¯å¦æ­£ç¡®ï¼Ÿï¼ˆå¯¹ç…§æ•°æ®æ‰‹å†Œï¼‰
    5. MIPI laneé€Ÿç‡æ˜¯å¦åœ¨å±å¹•æ”¯æŒèŒƒå›´å†…ï¼Ÿ

**Q: å¦‚ä½•è°ƒè¯•æ˜¾ç¤ºé—®é¢˜ï¼Ÿ**

::

    1. å¼€å¯é©±åŠ¨è°ƒè¯•ä¿¡æ¯ï¼š
       echo 8 > /proc/sys/kernel/printk
       echo 0x1f > /sys/module/drm/parameters/debug
       
    2. æŸ¥çœ‹DRMçŠ¶æ€ï¼š
       cat /sys/kernel/debug/dri/0/state
       
    3. ä½¿ç”¨modetestå·¥å…·æµ‹è¯•ï¼š
       modetest -M rockchip -s <connector_id>@<crtc_id>:<mode>

====================================
====================================

---

## é™„å½•ï¼šDRM/KMS æŠ€æœ¯å‚è€ƒæ‰‹å†Œ

> ä»¥ä¸‹å†…å®¹æ•´ç†è‡ª Linux å†…æ ¸å®˜æ–¹æ–‡æ¡£ï¼Œä¾›æ·±å…¥å­¦ä¹ å‚è€ƒã€‚
> 
> **è¯´æ˜**ï¼šåŸæ–‡ä¸­çš„ `kernel-doc` å¼•ç”¨æŒ‡å‘å†…æ ¸æºç ä¸­çš„æ³¨é‡Šæ–‡æ¡£ï¼Œ
> å¦‚éœ€æŸ¥çœ‹å®Œæ•´ APIï¼Œè¯·é˜…è¯»å¯¹åº”çš„å¤´æ–‡ä»¶å’Œæºæ–‡ä»¶ã€‚

---

### ä¸€ã€æ¨¡å¼é…ç½®åˆå§‹åŒ–

é©±åŠ¨ç¨‹åºå¿…é¡»è°ƒç”¨ `drm_mode_config_init()` æ¥åˆå§‹åŒ– KMS æ ¸å¿ƒã€‚
è¯¥å‡½æ•°ä¼šåˆå§‹åŒ– `struct drm_device` çš„ `mode_config` å­—æ®µã€‚

åˆå§‹åŒ–åï¼Œéœ€è¦è®¾ç½®ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `min_width`, `min_height` | å¸§ç¼“å†²åŒºæœ€å°å®½é«˜ï¼ˆåƒç´ ï¼‰ |
| `max_width`, `max_height` | å¸§ç¼“å†²åŒºæœ€å¤§å®½é«˜ï¼ˆåƒç´ ï¼‰ |
| `funcs` | æ¨¡å¼è®¾ç½®å›è°ƒå‡½æ•°ï¼ˆ`struct drm_mode_config_funcs *`ï¼‰ |

---

### äºŒã€KMS æ˜¾ç¤ºç®¡çº¿æ¦‚è¿°

KMS å¯¹å¤–å‘ˆç°çš„å¯¹è±¡ç»“æ„å¦‚ä¸‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     KMS æ˜¾ç¤ºç®¡çº¿                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  [ç”¨æˆ·ç©ºé—´åˆ›å»º]              [é™æ€å¯¹è±¡]         [å¯çƒ­æ’æ‹”]    â”‚
â”‚                                                             â”‚
â”‚  drm_framebuffer 1 â”€â”€â”                                      â”‚ 
â”‚                      â”œâ”€â”€â–¶ drm_plane A â”€â”€â”                   â”‚
â”‚  drm_framebuffer 2 â”€â”€â”˜                  â”‚                   â”‚
â”‚                      â”Œâ”€â”€â–¶ drm_plane B â”€â”€â”¤                   â”‚
â”‚                      â”‚                  â”‚                   â”‚
â”‚                      â”‚                  â–¼                   â”‚
â”‚                      â”‚            drm_crtc                  â”‚
â”‚                      â”‚                  â”‚                   â”‚
â”‚                      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                      â”‚         â–¼                 â–¼          â”‚
â”‚                      â”‚   drm_encoder A     drm_encoder B    â”‚
â”‚                      â”‚         â”‚                 â”‚          â”‚
â”‚                      â”‚         â–¼                 â–¼          â”‚
â”‚                      â”‚   drm_connector A   drm_connector B  â”‚
â”‚                      â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµè¯´æ˜**ï¼š

1. **Framebufferï¼ˆå¸§ç¼“å†²åŒºï¼‰** â†’ Planeï¼ˆå¹³é¢ï¼‰
   - `struct drm_framebuffer` å­˜å‚¨å›¾åƒæ•°æ®
   - ç”±ç”¨æˆ·ç©ºé—´åˆ›å»ºï¼Œå¯ä»¥å…³è”åˆ°ä»»æ„ Plane

2. **Planeï¼ˆå¹³é¢ï¼‰** â†’ CRTC
   - `struct drm_plane` ä» Framebuffer è¯»å–åƒç´ æ•°æ®
   - å¤šä¸ª Plane å¯ä»¥è¾“å…¥åˆ°åŒä¸€ä¸ª CRTC è¿›è¡Œåˆæˆ

3. **CRTC** â†’ Encoderï¼ˆç¼–ç å™¨ï¼‰
   - `struct drm_crtc` è´Ÿè´£æ··åˆå›¾å±‚ã€ç”Ÿæˆæ—¶åºä¿¡å·
   - ä¸€ä¸ª CRTC å¯ä»¥è¿æ¥å¤šä¸ª Encoder

4. **Encoderï¼ˆç¼–ç å™¨ï¼‰** â†’ Connectorï¼ˆè¿æ¥å™¨ï¼‰
   - `struct drm_encoder` å°†ä¿¡å·è½¬æ¢ä¸ºç‰¹å®šåè®®
   - æ¯ä¸ªæ´»åŠ¨çš„ Encoder å¯¹åº”ä¸€ä¸ªæ´»åŠ¨çš„ Connector

5. **Connectorï¼ˆè¿æ¥å™¨ï¼‰** â†’ æ˜¾ç¤ºå™¨
   - `struct drm_connector` ä»£è¡¨ç‰©ç†è¾“å‡ºç«¯å£
   - æ”¯æŒçƒ­æ’æ‹”æ£€æµ‹

---

### ä¸‰ã€å†…éƒ¨è¾“å‡ºç®¡çº¿ï¼ˆæ›´è´´è¿‘ç¡¬ä»¶ï¼‰

åœ¨é©±åŠ¨å†…éƒ¨ï¼Œè¾“å‡ºç®¡çº¿è¿˜åŒ…å«ä¸¤ä¸ªè¾…åŠ©å¯¹è±¡ï¼š

```
                    drm_crtc
                       â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼            â–¼            â–¼
    drm_encoder A  drm_encoder B  drm_encoder C
          â”‚            â”‚            â”‚
          â”‚            â–¼            â–¼
          â”‚       drm_bridge B  drm_bridge C1
          â”‚            â”‚            â”‚
          â”‚            â”‚            â–¼
          â”‚            â”‚       drm_bridge C2
          â”‚            â”‚            â”‚
          â–¼            â–¼            â–¼
    drm_connector A  drm_connector B  drm_connector C
                                      â”‚
                                      â–¼
                                  drm_panel
```

**Bridgeï¼ˆæ¡¥æ¥å™¨ï¼‰**ï¼š`struct drm_bridge`
- ç”¨äºä»£ç å¤ç”¨ï¼ˆåŒ SoC ä¸åŒæ¥å£ï¼Œæˆ–å¤–éƒ¨è½¬æ¢èŠ¯ç‰‡ï¼‰
- å¯ä»¥é“¾å¼è¿æ¥å¤šä¸ª Bridge
- å¯¹äºä½¿ç”¨ Bridge çš„é©±åŠ¨ï¼ŒEncoder é€šå¸¸åªæ˜¯ä¸€ä¸ªç©ºå£³

**Panelï¼ˆé¢æ¿ï¼‰**ï¼š`struct drm_panel`

- ä»£è¡¨å…·ä½“çš„æ˜¾ç¤ºé¢æ¿ï¼ˆLCD å±ï¼‰
- é€šå¸¸å…³è”åˆ° Connector çš„é©±åŠ¨ç§æœ‰ç»“æ„ä¸­
- è´Ÿè´£å±å¹•åˆå§‹åŒ–ã€ç”µæºç®¡ç†ç­‰

> **æ³¨æ„**ï¼šBridge é“¾å’Œ Panel çš„æ¥å£ç›®å‰ä»åœ¨æ¼”è¿›ä¸­ã€‚

---

### å››ã€æ¨¡å¼å¯¹è±¡ä¸å±æ€§

æ‰€æœ‰ KMS å¯¹è±¡éƒ½ç»§æ‰¿è‡ª `struct drm_mode_object`ï¼Œå®ƒæä¾›ï¼š

- **å¯¹è±¡ ID**ï¼šç”¨æˆ·ç©ºé—´é€šè¿‡ ID å¼•ç”¨å¯¹è±¡
- **å±æ€§ç®¡ç†**ï¼šæ”¯æŒåŠ¨æ€å±æ€§ç»‘å®š

```
å±æ€§ä¸å¯¹è±¡çš„å…³ç³»ï¼ˆå¤šå¯¹å¤šï¼‰ï¼š

  drm_property A â”€â”€â”¬â”€â”€â–¶ drm_mode_object A
                   â””â”€â”€â–¶ drm_mode_object B

  drm_property B â”€â”€â”€â”€â”€â”€â–¶ drm_mode_object A
```

**å…³é”®ç‚¹**ï¼š
- å±æ€§æœ¬èº«æ˜¯ç‹¬ç«‹å¯¹è±¡ï¼ˆ`struct drm_property`ï¼‰ï¼Œå®šä¹‰ç±»å‹å’Œå–å€¼èŒƒå›´
- åŒä¸€ä¸ªå±æ€§å¯ä»¥ç»‘å®šåˆ°å¤šä¸ªå¯¹è±¡ï¼ˆé€šè¿‡ `drm_object_attach_property()`ï¼‰
- è¿™ç§è®¾è®¡ä¾¿äºå±æ€§å¤ç”¨

---

### äº”ã€åŸå­æ¨¡å¼è®¾ç½®ï¼ˆAtomic Modesettingï¼‰

åŸå­æ¨¡å¼è®¾ç½®æ˜¯ç°ä»£ DRM çš„æ ¸å¿ƒç‰¹æ€§ï¼Œæä¾›äº‹åŠ¡æ€§çš„æ˜¾ç¤ºé…ç½®æ›´æ–°ã€‚

**è®¾è®¡åŸåˆ™**ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| å…¨æœ‰æˆ–å…¨æ—  | æäº¤å¤±è´¥æ—¶ä¸ä¿®æ”¹ä»»ä½•ç¡¬ä»¶çŠ¶æ€ |
| å¯æµ‹è¯• | æ”¯æŒ `TEST_ONLY` æ¨¡å¼ï¼Œå…ˆéªŒè¯é…ç½®æ˜¯å¦å¯è¡Œ |
| å¢é‡æ›´æ–° | åªéœ€æŒ‡å®šè¦ä¿®æ”¹çš„å±æ€§ |
| å¹¶è¡Œæ‰§è¡Œ | ä¸åŒ CRTC çš„æ›´æ–°å¯ä»¥å¹¶è¡Œè¿›è¡Œ |

**çŠ¶æ€ç®¡ç†æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    drm_atomic_state                         â”‚
â”‚                   ï¼ˆå¾…æäº¤çš„çŠ¶æ€é›†åˆï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ å¤åˆ¶çš„ drm_plane_state A                          â”‚    â”‚
â”‚  â”‚  â€¢ å¤åˆ¶çš„ drm_plane_state B                          â”‚    â”‚
â”‚  â”‚  â€¢ å¤åˆ¶çš„ drm_crtc_state                             â”‚    â”‚
â”‚  â”‚  â€¢ å¤åˆ¶çš„ drm_connector_state                        â”‚    â”‚
â”‚  â”‚  â€¢ å¤åˆ¶çš„é©±åŠ¨ç§æœ‰çŠ¶æ€                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ atomic_commit()
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      drm_device                             â”‚
â”‚                    ï¼ˆå½“å‰ç¡¬ä»¶çŠ¶æ€ï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ drm_plane Aâ”‚  â”‚ drm_plane Bâ”‚  â”‚  drm_crtc  â”‚  ...        â”‚
â”‚  â”‚     â”‚      â”‚  â”‚     â”‚      â”‚  â”‚     â”‚      â”‚             â”‚
â”‚  â”‚     â–¼      â”‚  â”‚     â–¼      â”‚  â”‚     â–¼      â”‚             â”‚
â”‚  â”‚plane_state â”‚  â”‚plane_state â”‚  â”‚ crtc_state â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·¥ä½œæµç¨‹**ï¼š

1. ç”¨æˆ·ç©ºé—´æ„å»º `drm_atomic_state`ï¼ŒåŒ…å«è¦ä¿®æ”¹çš„çŠ¶æ€
2. è°ƒç”¨ `atomic_check()` éªŒè¯é…ç½®åˆæ³•æ€§
3. éªŒè¯é€šè¿‡åï¼Œè°ƒç”¨ `atomic_commit()` åº”ç”¨åˆ°ç¡¬ä»¶
4. å¤±è´¥æ—¶ç›´æ¥ä¸¢å¼ƒçŠ¶æ€ï¼Œæ— éœ€å›æ»š

**çŠ¶æ€ç»“æ„ä½“**ï¼š

| å¯¹è±¡ç±»å‹ | çŠ¶æ€ç»“æ„ä½“ |
|----------|-----------|
| Plane | `struct drm_plane_state` |
| CRTC | `struct drm_crtc_state` |
| Connector | `struct drm_connector_state` |

é©±åŠ¨å¯ä»¥é€šè¿‡åµŒå…¥æ–¹å¼æ‰©å±•è¿™äº›ç»“æ„ï¼Œæ·»åŠ ç§æœ‰çŠ¶æ€ã€‚

---

### å…­ã€å„ç»„ä»¶è¯¦è§£

#### 6.1 CRTCï¼ˆæ˜¾ç¤ºæ§åˆ¶å™¨ï¼‰

**å®šä¹‰**ï¼šèŠ¯ç‰‡ä¸­è´Ÿè´£æ‰«æè¾“å‡ºçš„ç¡¬ä»¶å•å…ƒã€‚

**ä¸»è¦åŠŸèƒ½**ï¼š
- ç»´æŠ¤æŒ‡å‘ Framebuffer çš„æŒ‡é’ˆ
- å­˜å‚¨å½“å‰æ˜¾ç¤ºæ¨¡å¼ï¼ˆåˆ†è¾¨ç‡ã€åˆ·æ–°ç‡ç­‰ï¼‰
- æ”¯æŒç”»é¢å¹³ç§»ï¼ˆé€šè¿‡ x, y åç§»ï¼‰
- æ··åˆå¤šä¸ª Plane çš„å†…å®¹

**æ•°é‡é™åˆ¶**ï¼š
- CRTC æ•°é‡å†³å®šäº†åŒæ—¶å¯æ´»åŠ¨çš„ç‹¬ç«‹æ˜¾ç¤ºè¾“å‡ºæ•°
- RK3568 çš„ VOP2 æœ‰ 3 ä¸ªè§†é¢‘ç«¯å£ï¼Œå³ 3 ä¸ª CRTC

**åˆå§‹åŒ–**ï¼š

```c
// é©±åŠ¨å¿…é¡»è‡³å°‘æ³¨å†Œä¸€ä¸ª CRTC
drm_crtc_init_with_planes(dev, crtc, primary_plane, cursor_plane, 
                          &crtc_funcs, NULL);
```

> **æºç å‚è€ƒ**ï¼š`include/drm/drm_crtc.h`, `drivers/gpu/drm/drm_crtc.c`

---

#### 6.2 Framebufferï¼ˆå¸§ç¼“å†²åŒºï¼‰

**å®šä¹‰**ï¼šå­˜å‚¨å›¾åƒæ•°æ®çš„å†…å­˜åŒºåŸŸã€‚

**ä¸»è¦å±æ€§**ï¼š
- å®½åº¦ã€é«˜åº¦ï¼ˆåƒç´ ï¼‰
- åƒç´ æ ¼å¼ï¼ˆFOURCC ä»£ç ï¼Œå¦‚ `DRM_FORMAT_XRGB8888`ï¼‰
- æ¯è¡Œå­—èŠ‚æ•°ï¼ˆpitch/strideï¼‰

> **æºç å‚è€ƒ**ï¼š`include/drm/drm_framebuffer.h`, `drivers/gpu/drm/drm_framebuffer.c`

---

#### 6.3 Planeï¼ˆå¹³é¢/å›¾å±‚ï¼‰

**å®šä¹‰**ï¼šä» Framebuffer è¯»å–æ•°æ®å¹¶é€å…¥ CRTC çš„ç¡¬ä»¶å•å…ƒã€‚

**å›¾å±‚ç±»å‹**ï¼š

| ç±»å‹ | è¯´æ˜ |
|------|------|
| `DRM_PLANE_TYPE_PRIMARY` | ä¸»å›¾å±‚ï¼Œå¿…é¡»æœ‰ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢ |
| `DRM_PLANE_TYPE_OVERLAY` | å åŠ å›¾å±‚ï¼Œç”¨äºè§†é¢‘è¦†ç›–ç­‰ |
| `DRM_PLANE_TYPE_CURSOR` | å…‰æ ‡å›¾å±‚ï¼Œæ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ |

> **æºç å‚è€ƒ**ï¼š`include/drm/drm_plane.h`, `drivers/gpu/drm/drm_plane.c`

---

#### 6.4 Encoderï¼ˆç¼–ç å™¨ï¼‰

**å®šä¹‰**ï¼šå°† CRTC çš„é€šç”¨è§†é¢‘ä¿¡å·è½¬æ¢ä¸ºç‰¹å®šæ¥å£åè®®ã€‚

**å¸¸è§ç±»å‹**ï¼š

| ç±»å‹å¸¸é‡ | æ¥å£ |
|----------|------|
| `DRM_MODE_ENCODER_DSI` | MIPI DSI |
| `DRM_MODE_ENCODER_LVDS` | LVDS |
| `DRM_MODE_ENCODER_TMDS` | HDMI/DVI |
| `DRM_MODE_ENCODER_DAC` | VGA |

> **å†å²é—ç•™**ï¼šEncoder å¯¹è±¡æš´éœ²ç»™äº†ç”¨æˆ·ç©ºé—´ï¼Œä½†å®é™…ä¸Šä¸»è¦æ˜¯é©±åŠ¨å†…éƒ¨ä½¿ç”¨ã€‚
> ç°ä»£åŸå­é©±åŠ¨ä¸­ï¼ŒEncoder çš„å›è°ƒå‡½æ•°é€šå¸¸ä¸ºç©ºã€‚

> **æºç å‚è€ƒ**ï¼š`include/drm/drm_encoder.h`, `drivers/gpu/drm/drm_encoder.c`

---

#### 6.5 Connectorï¼ˆè¿æ¥å™¨ï¼‰

**å®šä¹‰**ï¼šä»£è¡¨ç‰©ç†æ˜¾ç¤ºè¾“å‡ºç«¯å£ã€‚

**ä¸»è¦åŠŸèƒ½**ï¼š
- çƒ­æ’æ‹”æ£€æµ‹
- è¯»å–æ˜¾ç¤ºå™¨ EDID ä¿¡æ¯
- æŠ¥å‘Šè¿æ¥çŠ¶æ€ï¼ˆconnected/disconnected/unknownï¼‰
- å­˜å‚¨æ”¯æŒçš„æ˜¾ç¤ºæ¨¡å¼åˆ—è¡¨

> **æºç å‚è€ƒ**ï¼š`include/drm/drm_connector.h`, `drivers/gpu/drm/drm_connector.c`

**å›å†™è¿æ¥å™¨**ï¼š
- ç‰¹æ®Šç±»å‹çš„ Connectorï¼Œå°† CRTC è¾“å‡ºå†™å›å†…å­˜
- ç”¨äºå±å¹•æˆªå›¾ã€å½•å±ç­‰åŠŸèƒ½
- å‚è€ƒï¼š`drivers/gpu/drm/drm_writeback.c`

---

### ä¸ƒã€KMS åˆå§‹åŒ–ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ Intel i915 é©±åŠ¨ä¸­ VGA è¾“å‡ºåˆå§‹åŒ–çš„ç¤ºä¾‹ï¼ˆå·²ç®€åŒ–ï¼‰ï¼š

```c
void intel_crt_init(struct drm_device *dev)
{
    struct drm_connector *connector;
    struct intel_output *intel_output;

    // 1. åˆ†é…é©±åŠ¨ç§æœ‰ç»“æ„
    intel_output = kzalloc(sizeof(struct intel_output), GFP_KERNEL);
    if (!intel_output)
        return;

    connector = &intel_output->base;

    // 2. åˆå§‹åŒ– Connectorï¼ˆVGA ç±»å‹ï¼‰
    drm_connector_init(dev, connector,
                       &intel_crt_connector_funcs, 
                       DRM_MODE_CONNECTOR_VGA);

    // 3. åˆå§‹åŒ– Encoderï¼ˆDAC ç±»å‹ï¼‰
    drm_encoder_init(dev, &intel_output->enc, 
                     &intel_crt_enc_funcs,
                     DRM_MODE_ENCODER_DAC);

    // 4. ç»‘å®š Encoder å’Œ Connector
    drm_connector_attach_encoder(connector, &intel_output->enc);

    // 5. è®¾ç½® DDC æ€»çº¿ï¼ˆç”¨äºè¯»å– EDIDï¼‰
    intel_output->ddc_bus = intel_i2c_create(dev, GPIOA, "CRTDDC_A");
    if (!intel_output->ddc_bus) {
        dev_err(&dev->pdev->dev, "DDC æ€»çº¿æ³¨å†Œå¤±è´¥\n");
        return;
    }

    // 6. è®¾ç½®è¾“å‡ºç±»å‹å’Œèƒ½åŠ›
    intel_output->type = INTEL_OUTPUT_ANALOG;
    connector->interlace_allowed = 0;
    connector->doublescan_allowed = 0;

    // 7. æ·»åŠ è¾…åŠ©å‡½æ•°
    drm_encoder_helper_add(&intel_output->enc, &intel_crt_helper_funcs);
    drm_connector_helper_add(connector, &intel_crt_connector_helper_funcs);

    // 8. æ³¨å†Œåˆ° sysfs
    drm_connector_register(connector);
}
```

---

### å…«ã€æ¸…ç†æµç¨‹

DRM æ ¸å¿ƒç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚é©±åŠ¨å¸è½½æ—¶éœ€è¦ï¼š

| å¯¹è±¡ç±»å‹ | æ¸…ç†å‡½æ•° |
|----------|----------|
| CRTC | `drm_crtc_cleanup()` |
| Plane | `drm_plane_cleanup()` |
| Encoder | `drm_encoder_cleanup()` |
| Connector | `drm_connector_unregister()` + `drm_connector_cleanup()` |
| çƒ­æ’æ‹”è½®è¯¢ | `drm_kms_helper_poll_fini()` |

---

### ä¹ã€KMS å±æ€§ç³»ç»Ÿ

DRM é€šè¿‡å±æ€§ï¼ˆPropertyï¼‰ç³»ç»Ÿå‘ç”¨æˆ·ç©ºé—´æš´éœ²å¯é…ç½®å‚æ•°ã€‚

**å±æ€§ç±»å‹**ï¼š

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| Range | æ•°å€¼èŒƒå›´ | äº®åº¦ 0-100 |
| Enum | æšä¸¾å€¼ | æ—‹è½¬ï¼š0Â°/90Â°/180Â°/270Â° |
| Blob | äºŒè¿›åˆ¶æ•°æ® | EDIDã€LUT è¡¨ |
| Bitmask | ä½æ©ç  | æ”¯æŒçš„æ ¼å¼é›†åˆ |

**æ ‡å‡† Connector å±æ€§**ï¼š
- `EDID`ï¼šæ˜¾ç¤ºå™¨çš„ EDID æ•°æ®
- `DPMS`ï¼šç”µæºç®¡ç†çŠ¶æ€
- `link-status`ï¼šé“¾æ¥çŠ¶æ€
- `content-type`ï¼šå†…å®¹ç±»å‹ï¼ˆæ¸¸æˆã€ç”µå½±ç­‰ï¼‰

**å¹³é¢åˆæˆå±æ€§**ï¼š
- `alpha`ï¼šé€æ˜åº¦
- `zpos`ï¼šZ è½´é¡ºåºï¼ˆå›¾å±‚å †å ï¼‰
- `rotation`ï¼šæ—‹è½¬è§’åº¦
- `pixel blend mode`ï¼šæ··åˆæ¨¡å¼

**é¢œè‰²ç®¡ç†å±æ€§**ï¼š
- `GAMMA_LUT`ï¼šä¼½é©¬æ ¡æ­£è¡¨
- `DEGAMMA_LUT`ï¼šåä¼½é©¬è¡¨
- `CTM`ï¼šé¢œè‰²å˜æ¢çŸ©é˜µ

---

### åã€å‚ç›´æ¶ˆéšï¼ˆVBlankï¼‰

**å®šä¹‰**ï¼šä¸¤å¸§å›¾åƒä¹‹é—´çš„é—´éš”æœŸï¼Œæ˜¾ç¤ºå™¨ä»åº•éƒ¨æ‰«æå›é¡¶éƒ¨ã€‚

**ä½œç”¨**ï¼š
- åŒæ­¥å¸§æ›´æ–°ï¼Œé¿å…æ’•è£‚ï¼ˆtearingï¼‰
- æä¾›æ—¶é—´æˆ³ç”¨äºåŠ¨ç”»è®¡ç®—
- è§¦å‘é¡µé¢ç¿»è½¬ï¼ˆpage flipï¼‰å®Œæˆäº‹ä»¶

**ç›¸å…³å‡½æ•°**ï¼š
- `drm_vblank_init()`ï¼šåˆå§‹åŒ– VBlank æ”¯æŒ
- `drm_crtc_vblank_get/put()`ï¼šè¯·æ±‚/é‡Šæ”¾ VBlank äº‹ä»¶
- `drm_crtc_handle_vblank()`ï¼šä¸­æ–­å¤„ç†ä¸­è°ƒç”¨

> **æºç å‚è€ƒ**ï¼š`include/drm/drm_vblank.h`, `drivers/gpu/drm/drm_vblank.c`

---

### åä¸€ã€ç›¸å…³æºç ä½ç½®

```
drivers/gpu/drm/
â”œâ”€â”€ drm_crtc.c              # CRTC æ ¸å¿ƒå®ç°
â”œâ”€â”€ drm_plane.c             # Plane æ ¸å¿ƒå®ç°
â”œâ”€â”€ drm_encoder.c           # Encoder æ ¸å¿ƒå®ç°
â”œâ”€â”€ drm_connector.c         # Connector æ ¸å¿ƒå®ç°
â”œâ”€â”€ drm_framebuffer.c       # Framebuffer æ ¸å¿ƒå®ç°
â”œâ”€â”€ drm_atomic.c            # åŸå­æäº¤å®ç°
â”œâ”€â”€ drm_mode_config.c       # æ¨¡å¼é…ç½®ç®¡ç†
â”œâ”€â”€ drm_mode_object.c       # æ¨¡å¼å¯¹è±¡åŸºç±»
â”œâ”€â”€ drm_property.c          # å±æ€§ç³»ç»Ÿ
â”œâ”€â”€ drm_vblank.c            # VBlank å¤„ç†
â”œâ”€â”€ drm_blend.c             # å›¾å±‚æ··åˆ
â”œâ”€â”€ drm_color_mgmt.c        # é¢œè‰²ç®¡ç†
â”œâ”€â”€ drm_fourcc.c            # åƒç´ æ ¼å¼å¤„ç†
â”œâ”€â”€ drm_dumb_buffers.c      # Dumb Buffer åˆ†é…
â”œâ”€â”€ drm_modeset_lock.c      # æ¨¡å¼è®¾ç½®é”
â”œâ”€â”€ drm_writeback.c         # å›å†™è¿æ¥å™¨
â”œâ”€â”€ panel/
â”‚   â””â”€â”€ panel-simple.c      # é€šç”¨é¢æ¿é©±åŠ¨
â””â”€â”€ rockchip/
    â”œâ”€â”€ rockchip_drm_drv.c  # Rockchip DRM ä¸»é©±åŠ¨
    â”œâ”€â”€ rockchip_drm_vop2.c # VOP2 (CRTC) é©±åŠ¨
    â””â”€â”€ dw-mipi-dsi.c       # MIPI DSI é©±åŠ¨
    
include/drm/
â”œâ”€â”€ drm_crtc.h
â”œâ”€â”€ drm_plane.h
â”œâ”€â”€ drm_encoder.h
â”œâ”€â”€ drm_connector.h
â”œâ”€â”€ drm_framebuffer.h
â”œâ”€â”€ drm_atomic.h
â”œâ”€â”€ drm_mode_config.h
â”œâ”€â”€ drm_mode_object.h
â”œâ”€â”€ drm_property.h
â”œâ”€â”€ drm_vblank.h
â”œâ”€â”€ drm_fourcc.h
â””â”€â”€ drm_modeset_lock.h
```

---

*æœ¬æ–‡æ¡£æ•´ç†è‡ª Linux å†…æ ¸æ–‡æ¡£ï¼Œå¦‚æœ‰é”™è¯¯æ¬¢è¿æŒ‡æ­£ã€‚*
